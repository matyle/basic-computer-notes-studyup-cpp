# è®¾è®¡åŸç†



## å†…å­˜ç®¡ç†çš„ç»„æˆ

ä¸‰ä¸ªç»„ä»¶

- ç”¨æˆ·ç¨‹åºï¼ˆMutatorï¼‰
- åˆ†é…å™¨ï¼ˆAllocatorï¼‰
- æ”¶é›†å™¨ï¼ˆCollectorï¼‰

å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šé€šè¿‡å†…å­˜åˆ†é…å™¨ç”³è¯·æ–°å†…å­˜ï¼Œè€Œåˆ†é…å™¨ä¼šè´Ÿè´£ä»å †ä¸­åˆå§‹åŒ–ç›¸åº”çš„å†…å­˜åŒºåŸŸã€‚

<img src="https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066411-mutator-allocator-collector.png" alt="mutator-allocator-collector1" style="zoom:33%;" />





## åˆ†é…å™¨



### çº¿æ€§åˆ†é…

çº¿æ€§åˆ†é…ï¼ˆBump Allocatorï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å†…å­˜åˆ†é…æ–¹æ³•ï¼Œä½†æ˜¯æœ‰è¾ƒå¤§çš„å±€é™æ€§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨çº¿æ€§åˆ†é…å™¨æ—¶ï¼Œåªéœ€è¦åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å†…å­˜ç‰¹å®šä½ç½®çš„æŒ‡é’ˆï¼Œå¦‚æœç”¨æˆ·ç¨‹åºå‘åˆ†é…å™¨ç”³è¯·å†…å­˜ï¼Œåˆ†é…å™¨åªéœ€è¦æ£€æŸ¥å‰©ä½™çš„ç©ºé—²å†…å­˜ã€è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸå¹¶ä¿®æ”¹æŒ‡é’ˆåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œå³ç§»åŠ¨ä¸‹å›¾ä¸­çš„æŒ‡é’ˆ





### ç©ºé—²é“¾è¡¨åˆ†é…

ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰å¯ä»¥==é‡ç”¨==å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œå®ƒåœ¨å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªç±»ä¼¼é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œç©ºé—²é“¾è¡¨åˆ†é…å™¨ä¼šä¾æ¬¡éå†ç©ºé—²çš„å†…å­˜å—ï¼Œæ‰¾åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œç„¶åç”³è¯·æ–°çš„èµ„æºå¹¶ä¿®æ”¹é“¾è¡¨ï¼š

![free-list-allocator](https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066446-free-list-allocator.png)

å› ä¸ºä¸åŒçš„å†…å­˜å—é€šè¿‡æŒ‡é’ˆæ„æˆäº†é“¾è¡¨ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼çš„åˆ†é…å™¨å¯ä»¥é‡æ–°åˆ©ç”¨å›æ”¶çš„èµ„æºï¼Œä½†æ˜¯å› ä¸ºåˆ†é…å†…å­˜æ—¶éœ€è¦éå†é“¾è¡¨ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯ ğ‘‚(ğ‘›)O(n)ã€‚

ç©ºé—²é“¾è¡¨åˆ†é…å™¨å¯ä»¥é€‰æ‹©ä¸åŒçš„ç­–ç•¥åœ¨é“¾è¡¨ä¸­çš„å†…å­˜å—ä¸­è¿›è¡Œé€‰æ‹©ï¼Œæœ€å¸¸è§çš„æ˜¯ä»¥ä¸‹å››ç§ï¼š



- é¦–æ¬¡é€‚åº”ï¼ˆFirst-Fitï¼‰â€” ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
- å¾ªç¯é¦–æ¬¡é€‚åº”ï¼ˆNext-Fitï¼‰â€” ä»ä¸Šæ¬¡éå†çš„ç»“æŸä½ç½®å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
- æœ€ä¼˜é€‚åº”ï¼ˆBest-Fitï¼‰â€” ä»é“¾è¡¨å¤´éå†æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å†…å­˜å—ï¼›
- ==éš”ç¦»é€‚åº”==ï¼ˆSegregated-Fitï¼‰â€” å°†å†…å­˜åˆ†å‰²æˆå¤šä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­çš„å†…å­˜å—å¤§å°ç›¸åŒï¼Œç”³è¯·å†…å­˜æ—¶å…ˆæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é“¾è¡¨ï¼Œå†ä»é“¾è¡¨ä¸­é€‰æ‹©åˆé€‚çš„å†…å­˜å—ï¼›



![segregated-list](https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066452-segregated-list.png)



ç±»ä¼¼äºä¼™ä¼´ç³»ç»Ÿ

è¯¥ç­–ç•¥ä¼šå°†å†…å­˜åˆ†å‰²æˆç”± 4ã€8ã€16ã€32 å­—èŠ‚çš„å†…å­˜å—ç»„æˆçš„é“¾è¡¨ï¼Œå½“æˆ‘ä»¬å‘å†…å­˜åˆ†é…å™¨ç”³è¯· 8 å­—èŠ‚çš„å†…å­˜æ—¶ï¼Œå®ƒä¼šåœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç©ºé—²å†…å­˜å—å¹¶è¿”å›ã€‚éš”ç¦»é€‚åº”çš„åˆ†é…ç­–ç•¥å‡å°‘äº†éœ€è¦éå†çš„å†…å­˜å—æ•°é‡ï¼Œæé«˜äº†å†…å­˜åˆ†é…çš„æ•ˆç‡ã€‚









## åˆ†çº§åˆ†é… 



çº¿ç¨‹ç¼“å­˜åˆ†é…ï¼ˆThread-Caching Mallocï¼ŒTCMallocï¼‰æ˜¯ç”¨äºåˆ†é…å†…å­˜çš„æœºåˆ¶ï¼Œå®ƒæ¯” glibc ä¸­çš„ `malloc` è¿˜è¦å¿«å¾ˆå¤šã€‚Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨å°±å€Ÿé‰´äº† TCMalloc çš„è®¾è®¡å®ç°é«˜é€Ÿçš„å†…å­˜åˆ†é…ï¼Œå®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ä½¿ç”¨å¤šçº§ç¼“å­˜å°†å¯¹è±¡æ ¹æ®å¤§å°åˆ†ç±»ï¼Œå¹¶æŒ‰ç…§ç±»åˆ«å®æ–½ä¸åŒçš„åˆ†é…ç­–ç•¥ã€‚



### å¯¹è±¡å¤§å°

| ç±»åˆ«   | å¤§å°             |
| ------ | ---------------- |
| å¾®å¯¹è±¡ | ï¼ˆ0ï¼Œ16Bï¼‰       |
| å°å¯¹è±¡ | [16B,32KB]       |
| å¤§å¯¹è±¡ | (32KB,+$\infin$) |





### å¤šçº§ç¼“å­˜

- çº¿ç¨‹ç¼“å­˜ ï¼ˆThread Cacheï¼‰ï¼šå¾®å¯¹è±¡
- ä¸­å¿ƒç¼“å­˜ï¼ˆcentral cacheï¼‰ï¼šå°å¯¹è±¡
- é¡µå †ï¼ˆpage heapï¼‰ï¼šå¤§å¯¹è±¡

<img src="https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066457-multi-level-cache.png" alt="multi-level-cache" style="zoom:50%;" />





==çº¿ç¨‹ç¼“å­˜å±äºæ¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹== ï¼Œå®ƒèƒ½å¤Ÿæ»¡è¶³çº¿ç¨‹ä¸Šç»å¤§å¤šæ•°çš„å†…å­˜åˆ†é…éœ€æ±‚ï¼Œå› ä¸ºä¸æ¶‰åŠå¤šçº¿ç¨‹ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ä½¿ç”¨äº’æ–¥é”æ¥ä¿æŠ¤å†…å­˜ï¼Œè¿™èƒ½å¤Ÿå‡å°‘é”ç«äº‰å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚å½“çº¿ç¨‹ç¼“å­˜ä¸èƒ½æ»¡è¶³éœ€æ±‚æ—¶ï¼Œè¿è¡Œæ—¶ä¼šä½¿ç”¨==ä¸­å¿ƒç¼“å­˜ä½œä¸ºè¡¥å……è§£å†³å°å¯¹è±¡çš„å†…å­˜åˆ†é…== ï¼Œ==åœ¨é‡åˆ°32KBä»¥ä¸Šçš„å¯¹è±¡æ—¶ï¼Œå†…å­˜åˆ†é…å™¨ä¼šé€‰æ‹©é¡µå †ç›´æ¥åˆ†é…å¤§å†…å­˜==ã€‚







### è™šæ‹Ÿå†…å­˜å¸ƒå±€



#### çº¿æ€§å†…å­˜

- spans åŒºåŸŸå­˜å‚¨äº†æŒ‡å‘å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå†…å­˜å•å…ƒä¼šç®¡ç†å‡ é¡µçš„å†…å­˜ç©ºé—´ï¼Œæ¯é¡µå¤§å°ä¸º 8KBï¼›
- bitmapï¼š`arena` åŒºåŸŸä¸­çš„å“ªäº›åœ°å€ä¿å­˜äº†å¯¹è±¡ï¼Œä½å›¾ä¸­çš„æ¯ä¸ªå­—èŠ‚ï¼ˆ8ä½ï¼‰éƒ½ä¼šè¡¨ç¤ºå †åŒºä¸­çš„ 32 å­—èŠ‚æ˜¯å¦ç©ºé—²ï¼›
- arenaï¼šçœŸæ­£çš„å †åŒºï¼Œè¿è¡Œæ—¶ä¼šå°† 8KB çœ‹åšä¸€é¡µï¼Œè¿™äº›å†…å­˜é¡µä¸­å­˜å‚¨äº†æ‰€æœ‰åœ¨å †ä¸Šåˆå§‹åŒ–çš„å¯¹è±¡ï¼›

<img src="https://gitee.com/matytan/tupic/raw/master/uPic/heap-before-go-1-10.png" alt="heap-before-go-1-" style="zoom:50%;" />



Go è¯­è¨€åœ¨åƒåœ¾å›æ”¶æ—¶ä¼šæ ¹æ®æŒ‡é’ˆçš„åœ°å€åˆ¤æ–­å¯¹è±¡æ˜¯å¦åœ¨å †ä¸­ï¼Œå¹¶é€šè¿‡ä¸Šä¸€æ®µä¸­ä»‹ç»çš„è¿‡ç¨‹æ‰¾åˆ°ç®¡ç†è¯¥å¯¹è±¡çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ã€‚è¿™äº›éƒ½å»ºç«‹åœ¨**å †åŒºçš„å†…å­˜æ˜¯è¿ç»­çš„**è¿™ä¸€å‡è®¾ä¸Šã€‚è¿™ç§è®¾è®¡è™½ç„¶ç®€å•å¹¶ä¸”æ–¹ä¾¿ï¼Œä½†æ˜¯åœ¨ C å’Œ Go æ··åˆä½¿ç”¨æ—¶ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼š

1. åˆ†é…çš„å†…å­˜åœ°å€ä¼šå‘ç”Ÿå†²çªï¼Œå¯¼è‡´å †çš„åˆå§‹åŒ–å’Œæ‰©å®¹å¤±è´¥[3](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:3)ï¼›
2. æ²¡æœ‰è¢«é¢„ç•™çš„å¤§å—å†…å­˜å¯èƒ½ä¼šè¢«åˆ†é…ç»™ C è¯­è¨€çš„äºŒè¿›åˆ¶ï¼Œå¯¼è‡´æ‰©å®¹åçš„å †ä¸è¿ç»­[4](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:4)ï¼›

çº¿æ€§çš„å †å†…å­˜éœ€è¦é¢„ç•™å¤§å—çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ç”³è¯·å¤§å—çš„å†…å­˜ç©ºé—´è€Œä¸ä½¿ç”¨æ˜¯ä¸åˆ‡å®é™…çš„ï¼Œä¸é¢„ç•™å†…å­˜ç©ºé—´å´ä¼šåœ¨ç‰¹æ®Šåœºæ™¯ä¸‹é€ æˆç¨‹åºå´©æºƒã€‚è™½ç„¶è¿ç»­å†…å­˜çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯è¿™äº›é—®é¢˜ä¹Ÿæ²¡æœ‰åŠæ³•å¿½ç•¥ã€‚

#### ç¨€ç–å†…å­˜

äºŒç»´ç¨€ç–å†…å­˜æ˜¯ Go è¯­è¨€åœ¨ 1.11 ä¸­æå‡ºçš„æ–¹æ¡ˆï¼Œä½¿ç”¨ç¨€ç–çš„å†…å­˜å¸ƒå±€ä¸ä»…èƒ½ç§»é™¤å †å¤§å°çš„ä¸Šé™[5](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:5)ï¼Œè¿˜èƒ½è§£å†³ C å’Œ Go æ··åˆä½¿ç”¨æ—¶çš„åœ°å€ç©ºé—´å†²çªé—®é¢˜[6](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:6)ã€‚ä¸è¿‡å› ä¸ºåŸºäºç¨€ç–å†…å­˜çš„å†…å­˜ç®¡ç†å¤±å»äº†å†…å­˜çš„è¿ç»­æ€§è¿™ä¸€å‡è®¾ï¼Œè¿™ä¹Ÿä½¿å†…å­˜ç®¡ç†å˜å¾—æ›´åŠ å¤æ‚ï¼š

<img src="https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066468-heap-after-go-1-11.png" alt="heap-after-go-1-1" style="zoom:50%;" />



```go
type heapArena struct {
	bitmap       [heapArenaBitmapBytes]byte
	spans        [pagesPerArena]*mspan
	pageInUse    [pagesPerArena / 8]uint8
	pageMarks    [pagesPerArena / 8]uint8
	pageSpecials [pagesPerArena / 8]uint8
	checkmarks   *checkmarksMap
	zeroedBase   uintptr //æŒ‡å‘äº†è¯¥ç»“æ„ä½“ç®¡ç†çš„å†…å­˜çš„åŸºåœ°å€
}
```





#### åœ°å€ç©ºé—´





|    çŠ¶æ€    |                             è§£é‡Š                             |
| :--------: | :----------------------------------------------------------: |
|   `None`   |         å†…å­˜æ²¡æœ‰è¢«ä¿ç•™æˆ–è€…æ˜ å°„ï¼Œæ˜¯åœ°å€ç©ºé—´çš„é»˜è®¤çŠ¶æ€         |
| `Reserved` |        è¿è¡Œæ—¶æŒæœ‰è¯¥åœ°å€ç©ºé—´ï¼Œä½†æ˜¯è®¿é—®è¯¥å†…å­˜ä¼šå¯¼è‡´é”™è¯¯        |
| `Prepared` | å†…å­˜è¢«ä¿ç•™ï¼Œä¸€èˆ¬æ²¡æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜ï¼Œè€Œè®¿é—®è¯¥ç‰‡å†…å­˜çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚å¯ä»¥å¿«é€Ÿè½¬æ¢åˆ° `Ready` çŠ¶æ€ |
|  `Ready`   |                        å¯ä»¥è¢«å®‰å…¨è®¿é—®                        |





# å†…å­˜ç®¡ç†ç»„ä»¶

Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨åŒ…å«å†…å­˜ç®¡ç†å•å…ƒã€çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œé¡µå †å‡ ä¸ªé‡è¦ç»„ä»¶ï¼Œæœ¬èŠ‚å°†ä»‹ç»è¿™å‡ ç§æœ€é‡è¦ç»„ä»¶å¯¹åº”çš„æ•°æ®ç»“æ„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ã€[`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache)ã€[`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) å’Œ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap)ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»å®ƒä»¬åœ¨å†…å­˜åˆ†é…å™¨ä¸­çš„ä½œç”¨ä»¥åŠå®ç°ã€‚



<img src="https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066479-go-memory-layout.png" alt="go-memory-layou" style="zoom:33%;" />

æ‰€æœ‰çš„ Go è¯­è¨€ç¨‹åºéƒ½ä¼šåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–å¦‚ä¸Šå›¾æ‰€ç¤ºçš„å†…å­˜å¸ƒå±€ï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½ä¼šåˆ†é…ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ç”¨äºå¤„ç†å¾®å¯¹è±¡å’Œå°å¯¹è±¡çš„åˆ†é…ï¼Œå®ƒä»¬ä¼šæŒæœ‰å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ã€‚



### å†…å­˜ç®¡ç†å•å…ƒmspan

[`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) æ˜¯ Go è¯­è¨€å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å« `next` å’Œ `prev` ä¸¤ä¸ªå­—æ®µï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å‘äº†å‰ä¸€ä¸ªå’Œåä¸€ä¸ª [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼š

```go
type mspan struct {
	next *mspan
	prev *mspan
	...
}
```

![mspan-and-linked-list](https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066485-mspan-and-linked-list.png)





### é¡µå’Œå†…å­˜

```go
type mspan struct {
	startAddr uintptr // èµ·å§‹åœ°å€
	npages    uintptr // é¡µæ•°
	freeindex uintptr

	allocBits  *gcBits
	gcmarkBits *gcBits
	allocCache uint64
	...
}
```

- `startAddr` å’Œ `npages` â€” ç¡®å®šè¯¥ç»“æ„ä½“ç®¡ç†çš„å¤šä¸ªé¡µæ‰€åœ¨çš„å†…å­˜ï¼Œæ¯ä¸ªé¡µçš„å¤§å°éƒ½æ˜¯ 8KBï¼›

- `freeindex` â€” æ‰«æé¡µä¸­ç©ºé—²å¯¹è±¡çš„åˆå§‹ç´¢å¼•ï¼›

- `allocBits` å’Œ `gcmarkBits` â€” åˆ†åˆ«ç”¨äºæ ‡è®°å†…å­˜çš„å ç”¨å’Œå›æ”¶æƒ…å†µï¼›

- `allocCache` â€” `allocBits` çš„è¡¥ç ï¼Œå¯ä»¥ç”¨äºå¿«é€ŸæŸ¥æ‰¾å†…å­˜ä¸­æœªè¢«ä½¿ç”¨çš„å†…å­˜ï¼›

  

  [`ntime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ä¼šä»¥ä¸¤ç§ä¸åŒçš„è§†è§’çœ‹å¾…ç®¡ç†çš„å†…å­˜ï¼Œå½“ç»“æ„ä½“ç®¡ç†çš„å†…å­˜ä¸è¶³æ—¶ï¼Œè¿è¡Œæ—¶ä¼šä»¥é¡µä¸ºå•ä½å‘å †ç”³è¯·å†…å­˜ï¼š

<img src="https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066492-mspan-and-pages.png" alt="mspan-and-pages1" style="zoom:50%;" />



å½“ç”¨æˆ·ç¨‹åºæˆ–è€…çº¿ç¨‹å‘ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ `allocCache` å­—æ®µä»¥å¯¹è±¡ä¸ºå•ä½åœ¨ç®¡ç†çš„å†…å­˜ä¸­å¿«é€ŸæŸ¥æ‰¾å¾…åˆ†é…çš„ç©ºé—´ï¼š

<img src="https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066499-mspan-and-objects.png" alt="mspan-and-objects1" style="zoom:50%;" />

å¦‚æœæˆ‘ä»¬èƒ½åœ¨å†…å­˜ä¸­æ‰¾åˆ°ç©ºé—²çš„å†…å­˜å•å…ƒä¼šç›´æ¥è¿”å›ï¼Œå½“å†…å­˜ä¸­ä¸åŒ…å«ç©ºé—²çš„å†…å­˜æ—¶ï¼Œä¸Šä¸€çº§çš„ç»„ä»¶ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ä¼šä¸ºè°ƒç”¨ [`runtime.mcache.refill`](https://draveness.me/golang/tree/runtime.mcache.refill) æ›´æ–°å†…å­˜ç®¡ç†å•å…ƒä»¥æ»¡è¶³ä¸ºæ›´å¤šå¯¹è±¡åˆ†é…å†…å­˜çš„éœ€æ±‚ã€‚





#### çŠ¶æ€

è¿è¡Œæ—¶ä¼šä½¿ç”¨ [`runtime.mSpanStateBox`](https://draveness.me/golang/tree/runtime.mSpanStateBox) å­˜å‚¨å†…å­˜ç®¡ç†å•å…ƒçš„çŠ¶æ€ [`runtime.mSpanState`](https://draveness.me/golang/tree/runtime.mSpanState)ï¼š

```go
type mspan struct {
	...
	state       mSpanStateBox
	...
}
```

mSpanStateBoxä¸­æœ‰å››ç§çŠ¶æ€ï¼š `mSpanDead`ã€`mSpanInUse`ã€`mSpanManual` å’Œ `mSpanFree`



- åœ¨åƒåœ¾å›æ”¶çš„ä»»æ„é˜¶æ®µï¼Œå¯èƒ½ä» `mSpanFree` è½¬æ¢åˆ° `mSpanInUse` å’Œ `mSpanManual`ï¼›
- åœ¨åƒåœ¾å›æ”¶çš„æ¸…é™¤é˜¶æ®µï¼Œå¯èƒ½ä» `mSpanInUse` å’Œ `mSpanManual` è½¬æ¢åˆ° `mSpanFree`ï¼›
- åœ¨åƒåœ¾å›æ”¶çš„æ ‡è®°é˜¶æ®µï¼Œä¸èƒ½ä» `mSpanInUse` å’Œ `mSpanManual` è½¬æ¢åˆ° `mSpanFree`ï¼›

è®¾ç½® [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çŠ¶æ€çš„æ“ä½œå¿…é¡»æ˜¯åŸå­æ€§çš„ä»¥é¿å…åƒåœ¾å›æ”¶é€ æˆçš„çº¿ç¨‹ç«äº‰é—®é¢˜ã€‚



#### è·¨åº¦ç±»

[`runtime.spanClass`](https://draveness.me/golang/tree/runtime.spanClass) æ˜¯ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çš„è·¨åº¦ç±»ï¼Œå®ƒå†³å®šäº†å†…å­˜ç®¡ç†å•å…ƒä¸­å­˜å‚¨çš„å¯¹è±¡å¤§å°å’Œä¸ªæ•°ï¼š



```go
type mspan struct {
	...
	spanclass   spanClass
	...
}
```

Go è¯­è¨€çš„å†…å­˜ç®¡ç†æ¨¡å—ä¸­ä¸€å…±åŒ…å« 67 ç§è·¨åº¦ç±»ï¼Œæ¯ä¸€ä¸ªè·¨åº¦ç±»éƒ½ä¼šå­˜å‚¨ç‰¹å®šå¤§å°çš„å¯¹è±¡å¹¶ä¸”åŒ…å«ç‰¹å®šæ•°é‡çš„é¡µæ•°ä»¥åŠå¯¹è±¡ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¼šè¢«é¢„é€‰è®¡ç®—å¥½å¹¶å­˜å‚¨åœ¨ [`runtime.class_to_size`](https://draveness.me/golang/tree/runtime.class_to_size) å’Œ [`runtime.class_to_allocnpages`](https://draveness.me/golang/tree/runtime.class_to_allocnpages) ç­‰å˜é‡ä¸­ï¼š







### çº¿ç¨‹ç¼“å­˜ mcache

ç”¨æ¥ç¼“å­˜ç”¨ç”¨æˆ·ç¨‹åºç”³è¯·çš„å¾®å°å¯¹è±¡ï¼Œæ¯ä¸ªç°åœºç‹¬äº«ï¼Œæ— éœ€é”

[`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) æ˜¯ Go è¯­è¨€ä¸­çš„çº¿ç¨‹ç¼“å­˜ï¼Œå®ƒä¼šä¸çº¿ç¨‹ä¸Šçš„å¤„ç†å™¨ä¸€ä¸€ç»‘å®šï¼Œä¸»è¦ç”¨æ¥ç¼“å­˜ç”¨æˆ·ç¨‹åºç”³è¯·çš„å¾®å°å¯¹è±¡ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜éƒ½æŒæœ‰ 67* 2 ä¸ª [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼Œè¿™äº›å†…å­˜ç®¡ç†å•å…ƒéƒ½å­˜å‚¨åœ¨ç»“æ„ä½“çš„ `alloc` å­—æ®µä¸­ï¼š



<img src="https://gitee.com/matytan/tupic/raw/master/uPic/2020-02-29-15829868066512-mcache-and-mspans-20211224173831201.png" alt="mcache-and-mspan" style="zoom:50%;" />



#### åˆå§‹åŒ–

è¿è¡Œæ—¶åœ¨åˆå§‹åŒ–å¤„ç†å™¨æ—¶ä¼šè°ƒç”¨ [`runtime.allocmcache`](https://draveness.me/golang/tree/runtime.allocmcache) åˆå§‹åŒ–çº¿ç¨‹ç¼“å­˜ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ç³»ç»Ÿæ ˆä¸­ä½¿ç”¨ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) ä¸­çš„çº¿ç¨‹ç¼“å­˜åˆ†é…å™¨åˆå§‹åŒ–æ–°çš„ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ç»“æ„ä½“ï¼š

```go
func allocmcache() *mcache {
	var c *mcache
	systemstack(func() {
		lock(&mheap_.lock)
		c = (*mcache)(mheap_.cachealloc.alloc())
		c.flushGen = mheap_.sweepgen
		unlock(&mheap_.lock)
	})
	for i := range c.alloc {
		c.alloc[i] = &emptymspan
	}
	c.nextSample = nextSample()
	return c
}
```

å°±åƒæˆ‘ä»¬åœ¨ä¸Šé¢æåˆ°çš„ï¼Œåˆå§‹åŒ–åçš„ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ä¸­çš„æ‰€æœ‰ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) éƒ½æ˜¯ç©ºçš„å ä½ç¬¦ `emptymspan`ã€‚





#### æ›¿æ¢

[`runtime.mcache.refill`](https://draveness.me/golang/tree/runtime.mcache.refill) ä¼šä¸ºçº¿ç¨‹ç¼“å­˜è·å–ä¸€ä¸ªæŒ‡å®šè·¨åº¦ç±»çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œè¢«æ›¿æ¢çš„å•å…ƒä¸èƒ½åŒ…å«ç©ºé—²çš„å†…å­˜ç©ºé—´ï¼Œè€Œè·å–çš„å•å…ƒä¸­éœ€è¦è‡³å°‘åŒ…å«ä¸€ä¸ªç©ºé—²å¯¹è±¡ç”¨äºåˆ†é…å†…å­˜ï¼š



#### å¾®åˆ†é…å™¨

çº¿ç¨‹ç¼“å­˜ä¸­è¿˜åŒ…å«å‡ ä¸ªç”¨äºåˆ†é…å¾®å¯¹è±¡çš„å­—æ®µï¼Œä¸‹é¢çš„è¿™ä¸‰ä¸ªå­—æ®µç»„æˆäº†å¾®å¯¹è±¡åˆ†é…å™¨ï¼Œä¸“é—¨ç®¡ç† 16 å­—èŠ‚ä»¥ä¸‹çš„å¯¹è±¡ï¼š





### ä¸­å¿ƒç¼“å­˜mcentral

éœ€è¦é”

æ¯ä¸ªä¸­å¿ƒç¼“å­˜éƒ½ä¼š==ç®¡ç†æŸä¸ªè·¨åº¦ç±»çš„å†…å­˜ç®¡ç†å•å…ƒ==ï¼Œå®ƒä¼šåŒæ—¶æŒæœ‰ä¸¤ä¸ª [`runtime.spanSet`](https://draveness.me/golang/tree/runtime.spanSet)ï¼Œåˆ†åˆ«å­˜å‚¨åŒ…å«ç©ºé—²å¯¹è±¡å’Œä¸åŒ…å«ç©ºé—²å¯¹è±¡çš„å†…å­˜ç®¡ç†å•å…ƒã€‚





## é¡µå † mheap





# å†…å­˜åˆ†é…



## å¾®å¯¹è±¡

Go è¯­è¨€è¿è¡Œæ—¶å°†å°äº 16 å­—èŠ‚çš„å¯¹è±¡åˆ’åˆ†ä¸ºå¾®å¯¹è±¡ï¼Œå®ƒä¼šä½¿ç”¨çº¿ç¨‹ç¼“å­˜ä¸Šçš„å¾®åˆ†é…å™¨æé«˜å¾®å¯¹è±¡åˆ†é…çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨å®ƒæ¥åˆ†é…è¾ƒå°çš„å­—ç¬¦ä¸²ä»¥åŠé€ƒé€¸çš„ä¸´æ—¶å˜é‡ã€‚

## å°å¯¹è±¡



## å¤§å¯¹è±¡



